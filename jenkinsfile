pipeline {
    agent any

    environment {
        AWS_REGION = "ap-south-1"
        TF_VAR_app_version = "build-${BUILD_ID}"   

   
        AWS_CRED = 'python'

       
        TERRAFORM_DIR = "."
    }

    triggers {
        githubPush()   
    }

    stages {

        stage('üì• Clone Repo') {
            steps {
                echo "Pulling source code from GitHub..."
                checkout scm
            }
        }

        stage('üîë Configure AWS Credentials') {
            steps {
                withCredentials([string(credentialsId: "${AWS_CRED}", variable: 'AWS_CREDS')]) {
                    sh '''
                        echo "Configuring AWS credentials..."
                        export AWS_ACCESS_KEY_ID=$(echo $AWS_CREDS | cut -d ':' -f1)
                        export AWS_SECRET_ACCESS_KEY=$(echo $AWS_CREDS | cut -d ':' -f2)
                        export AWS_DEFAULT_REGION='ap-south-1'
                        echo "AWS auth successful."
                    '''
                }
            }
        }

        stage('‚öô Terraform Init') {
            steps {
                sh """
                    cd ${TERRAFORM_DIR}
                    terraform init
                """
            }
        }

        stage('üîç Terraform Plan') {
            steps {
                sh """
                    cd ${TERRAFORM_DIR}
                    terraform plan -out=tfplan -var="app_version=${TF_VAR_app_version}"
                """
            }
        }

        stage('üöÄ Terraform Apply') {
            steps {
                sh """
                    cd ${TERRAFORM_DIR}
                    terraform apply -auto-approve tfplan
                """
            }
        }

        stage('üåê Show ALB URL') {
            steps {
                sh """
                    cd ${TERRAFORM_DIR}
                    terraform output alb_dns_name
                """
            }
        }
    }

    post {
        success {
            echo "üöÄ Deployment Successful ‚Äî Version: ${TF_VAR_app_version}"
        }
        failure {
            echo "‚ùå Deployment Failed ‚Äî Check console logs"
        }
    }
}
